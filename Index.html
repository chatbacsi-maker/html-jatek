<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ ChatBacsi Snake</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: pan-y;
        }
        
        body {
            font-family: 'Arial', 'Helvetica Neue', Helvetica, sans-serif;
            background: url('https://kephost.net/p/MjIyODE2Mw.jpg');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .container {
            text-align: center;
            max-width: 500px;
            width: 100%;
            padding-bottom: 15px;
            position: relative;
            background: rgba(15, 52, 96, 0.75);
            border-radius: 15px;
            margin-top: 10px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 215, 0, 0.4);
        }
        
        .header-logo {
            max-width: 260px;
            width: 85%;
            height: auto;
            margin-bottom: 5px;
            margin-top: 5px;
        }
        
        .goal-title {
            color: #FFD700;
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            font-weight: bold;
            letter-spacing: 1px;
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            0% { text-shadow: 0 0 5px rgba(255, 215, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3); }
            100% { text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.5), 0 0 30px rgba(255, 215, 0, 0.3); }
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            background: rgba(255, 215, 0, 0.15);
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 1rem;
            border: 1px solid rgba(255, 215, 0, 0.4);
        }
        
        #gameCanvas {
            border: 3px solid #FF0000;
            border-radius: 10px;
            background-color: rgba(15, 52, 96, 0.65);
            display: block;
            margin: 0 auto;
            box-shadow: 0 0 25px rgba(255, 0, 0, 0.4);
            width: 100%;
            max-width: 400px;
            height: auto;
            aspect-ratio: 1;
            touch-action: none;
            transition: transform 0.05s linear;
        }
        
        .buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            background: rgba(255, 215, 0, 0.95);
            border: none;
            border-radius: 50px;
            color: #1a1a2e;
            font-size: 0.95rem;
            padding: 8px 18px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            min-width: 100px;
        }
        
        .action-btn.reset {
            background: rgba(255, 107, 107, 0.95);
            color: white;
        }
        
        .action-btn:active {
            transform: scale(0.95);
        }
        
        .instructions {
            background: rgba(255, 215, 0, 0.15);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.8rem;
            line-height: 1.4;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .instructions strong {
            color: #FFD700;
        }
        
        .swipe-hint {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #FFD700;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .game-over {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 46, 0.98);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 3px solid #FF0000;
            z-index: 100;
            width: 90%;
            max-width: 320px;
            box-shadow: 0 0 40px rgba(255, 0, 0, 0.5);
        }
        
        .win-screen {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 300;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .win-image {
            width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.8);
            animation: winGlow 3s infinite alternate;
        }
        
        @keyframes winGlow {
            0% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3); }
            100% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.9), 0 0 80px rgba(255, 215, 0, 0.6), 0 0 120px rgba(255, 215, 0, 0.4); }
        }
        
        .win-message {
            color: #FFD700;
            font-size: 1.8rem;
            margin-top: 15px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }
        
        .game-over-title {
            color: #ff6b6b;
            font-size: 1.5rem;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .special-death-message {
            color: #ff4444;
            font-size: 1.1rem;
            margin: 10px 0;
            font-weight: bold;
            animation: blink 0.5s infinite alternate;
        }
        
        @keyframes blink {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }
        
        .final-score {
            margin: 10px 0;
            font-size: 1.2rem;
            color: #FFD700;
        }
        
        .wall-counter {
            margin-top: 6px;
            font-size: 0.8rem;
            color: #FFD700;
            opacity: 0.9;
        }
        
        .powerup-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            z-index: 200;
            font-size: 1.3rem;
            line-height: 1.6;
            max-width: 380px;
            width: 90%;
            border: 4px solid #4169E1;
            display: none;
            box-shadow: 0 0 50px rgba(65, 105, 225, 0.9);
        }
        
        .powerup-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(65, 105, 225, 0.4);
            z-index: 150;
            display: none;
            pointer-events: none;
        }
        
        .speed-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(65, 105, 225, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            display: none;
        }
        
        .earthquake-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.3);
            z-index: 180;
            display: none;
            pointer-events: none;
            animation: flash 0.5s infinite alternate;
        }
        
        .salad-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(50, 205, 50, 0.3);
            z-index: 150;
            display: none;
            pointer-events: none;
        }
        
        .reverse-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 255, 0.2);
            z-index: 150;
            display: none;
            pointer-events: none;
        }
        
        .reverse-timer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.7);
            z-index: 160;
            text-shadow: 0 0 10px rgba(255, 0, 255, 0.8);
            display: none;
        }
        
        @keyframes flash {
            0% { opacity: 0.2; }
            100% { opacity: 0.5; }
        }
        
        @media (max-width: 480px) {
            .container { padding: 12px; margin-top: 5px; }
            .header-logo { max-width: 230px; margin-top: 0; }
            .goal-title { font-size: 1.8rem; margin-bottom: 8px; }
            .game-info { font-size: 0.9rem; padding: 8px 10px; }
            .action-btn { font-size: 0.85rem; padding: 7px 14px; min-width: 90px; }
            .game-over-title { font-size: 1.3rem; }
            .final-score { font-size: 1.1rem; }
            .powerup-message { font-size: 1.1rem; padding: 20px; }
            .speed-indicator { font-size: 0.75rem; padding: 5px 10px; }
            .reverse-timer { font-size: 36px; }
            .win-message { font-size: 1.4rem; }
        }
        
        @media (max-width: 350px) {
            .header-logo { max-width: 200px; }
            .goal-title { font-size: 1.6rem; }
            .buttons { gap: 8px; }
            .action-btn { min-width: 85px; padding: 6px 12px; }
            .reverse-timer { font-size: 28px; }
            .win-message { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="https://kephost.net/p/MjIyNzA1Mw.png" class="header-logo" alt="ChatBacsi Logo">
        <div class="goal-title">C√âL: 1000</div>
        
        <div class="game-info">
            <div>Pont: <span id="score">0</span></div>
            <div>Rekord: <span id="highScore">0</span></div>
            <div>Win: <span id="winCount">0</span></div>
        </div>
        
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        
        <div class="wall-counter">K√∂vetkez≈ë fal: <span id="nextWallAt">50</span> pontn√°l</div>
        <div class="speed-indicator" id="speedIndicator">2X SEBESS√âG!</div>
        <div class="swipe-hint">üëÜ Cs√∫sztasd az ujjad a k√©perny≈ën!</div>
        
        <div class="buttons">
            <button class="action-btn" onclick="startGame()">START</button>
            <button class="action-btn" onclick="pauseGame()">SZ√úNET</button>
            <button class="action-btn reset" onclick="resetGame()">√öJ J√ÅT√âK</button>
        </div>
        
        <div class="instructions">
            <p><strong>√ötmutat√≥:</strong> Haszn√°ld az ujjad! üëÜü•µ</p>
            <p>‚Ä¢ Balra/jobbra/fel/le cs√∫sztat√°s</p>
            <p>‚Ä¢ Norm√°l √©tel: +10 pont</p>
         </div>
        
        <div class="game-over" id="gameOverScreen">
            <div class="game-over-title">üíÄ MEGPUSZTULT√ÅL! üíÄ</div>
            <div class="special-death-message" id="specialDeathMessage" style="display: none;"></div>
            <div class="final-score">Pontod: <span id="finalScore">0</span></div>
            <button class="action-btn reset" onclick="startGame()" style="margin-top: 10px;">√öJRA BMEG!</button>
        </div>
        
        <div class="win-screen" id="winScreen">
            <img src="https://kephost.net/p/MjIyODMyMw.png" class="win-image" alt="GY≈êZELEM!">
            <div class="win-message">GY≈êZT√âL! üèÜ</div>
            <button class="action-btn" onclick="startGame()" style="margin-top: 15px; background: rgba(255, 215, 0, 0.95);">√öJ J√ÅT√âK</button>
        </div>
        
        <div class="powerup-message" id="powerupMessage"></div>
        <div class="powerup-effect" id="powerupEffect"></div>
        <div class="earthquake-effect" id="earthquakeEffect"></div>
        <div class="salad-effect" id="saladEffect"></div>
        <div class="reverse-effect" id="reverseEffect"></div>
        <div class="reverse-timer" id="reverseTimer"></div>
    </div>

    <script>
        // === K√âPEK BET√ñLT√âSE ===
        let imagesLoaded = {
            food: false,
            specialFood1: false,
            specialFood2: false,
            saladFood: false,
            snakeHead: false,
            snakeBody: false,
            winImage: false
        };
        
        const foodImage = new Image();
        const specialFood1Image = new Image();
        const specialFood2Image = new Image();
        const saladFoodImage = new Image();
        const snakeHeadImage = new Image();
        const snakeBodyImage = new Image();
        const winImage = new Image();
        
        foodImage.onload = function() { imagesLoaded.food = true; draw(); };
        specialFood1Image.onload = function() { imagesLoaded.specialFood1 = true; draw(); };
        specialFood2Image.onload = function() { imagesLoaded.specialFood2 = true; draw(); };
        saladFoodImage.onload = function() { imagesLoaded.saladFood = true; draw(); };
        snakeHeadImage.onload = function() { imagesLoaded.snakeHead = true; draw(); };
        snakeBodyImage.onload = function() { imagesLoaded.snakeBody = true; draw(); };
        winImage.onload = function() { imagesLoaded.winImage = true; };
        
        foodImage.src = 'https://kephost.net/p/MjIyNjk1Ng.png';
        specialFood1Image.src = 'https://kephost.net/p/MjIyNzA3NA.png';
        specialFood2Image.src = 'https://kephost.net/p/MjIyNzA3Mw.png';
        saladFoodImage.src = 'https://kephost.net/p/MjIyODA3MQ.png';
        snakeHeadImage.src = 'https://kephost.net/p/MjIyNzQxMA.jpg';
        snakeBodyImage.src = 'https://kephost.net/p/MjIyNzQxMQ.jpg';
        winImage.src = 'https://kephost.net/p/MjIyODMyMw.png';

        // === J√ÅT√âK V√ÅLTOZ√ìK ===
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const box = 20;
        
        let snake = [];
        let food = {};
        let specialFood1 = null;
        let specialFood2 = null;
        let saladFood = null;
        let walls = [];
        let score = 0;
        let highScore = localStorage.getItem('chatbacsiHighScore') || 0;
        let winCount = localStorage.getItem('chatbacsiWinCount') || 0;
        let wallCount = 0;
        let nextWallScore = 50;
        let wallSequence = [50, 120, 210, 340, 530, 810, 1190, 1720, 2440, 3390];
        let wallSequenceIndex = 0;
        let direction = 'right';
        let originalDirection = 'right';
        let game;
        let gameRunning = false;
        let gamePaused = false;
        let baseGameSpeed = 150;
        let currentGameSpeed = 150;
        let touchStartX = 0;
        let touchStartY = 0;
        let specialFood1SpawnScore = 40;
        let specialFood2SpawnScore = 100;
        let specialFood1DespawnScore = null;
        let specialFood2DespawnScore = null;
        let saladFoodSpawned = false;
        let saladFoodDespawnScore = null;
        let powerupActive = false;
        let powerupPaused = false;
        let powerupTimer = null;
        let specialFood2Spawned = false;
        let powerupEndTimer = null;
        let gameWon = false;
        
        // === F√ñLDRENG√âS V√ÅLTOZ√ìK ===
        let earthquakeActive = false;
        let earthquakeTimer = null;
        let earthquakeShakeInterval = null;
        let earthquakeFlashInterval = null;
        let originalCanvasTransform = '';
        let score200Triggered = false;
        let score750Triggered = false;
        
        // === FORD√çTOTT IR√ÅNY V√ÅLTOZ√ìK ===
        let reverseActive = false;
        let reverseTimer = null;
        let reverseCountdownInterval = null;
        let reverseCountdown = 10;
        let score500Triggered = false;

        // Elemek
        const scoreElement = document.getElementById('score');
        const highScoreElement = document.getElementById('highScore');
        const winCountElement = document.getElementById('winCount');
        const nextWallElement = document.getElementById('nextWallAt');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const winScreen = document.getElementById('winScreen');
        const finalScoreElement = document.getElementById('finalScore');
        const specialDeathMessage = document.getElementById('specialDeathMessage');
        const powerupMessage = document.getElementById('powerupMessage');
        const powerupEffect = document.getElementById('powerupEffect');
        const speedIndicator = document.getElementById('speedIndicator');
        const earthquakeEffect = document.getElementById('earthquakeEffect');
        const saladEffect = document.getElementById('saladEffect');
        const reverseEffect = document.getElementById('reverseEffect');
        const reverseTimerElement = document.getElementById('reverseTimer');

        highScoreElement.textContent = highScore;
        winCountElement.textContent = winCount;
        nextWallElement.textContent = wallSequence[wallSequenceIndex];

        // === FUNKCI√ìK ===
        function initSnake() {
            snake = [];
            snake[0] = { x: 9 * box, y: 10 * box };
            snake[1] = { x: 8 * box, y: 10 * box };
        }

        function createFood() {
            let newFood;
            let attempts = 0;
            const maxAttempts = 200;
            
            do {
                newFood = {
                    x: Math.floor(Math.random() * (canvas.width / box)) * box,
                    y: Math.floor(Math.random() * (canvas.height / box)) * box
                };
                attempts++;
                
                // Ellen≈ërizz√ºk, hogy a falak mell√© ker√ºl-e (legal√°bb 1 egys√©g t√°vols√°g)
                let tooCloseToWall = false;
                for (let i = 0; i < walls.length; i++) {
                    const wall = walls[i];
                    const distanceX = Math.abs(newFood.x - wall.x);
                    const distanceY = Math.abs(newFood.y - wall.y);
                    
                    // Ha a fal mell√© ker√ºlne (azonos vagy szomsz√©dos poz√≠ci√≥)
                    if (distanceX < box * 2 && distanceY < box * 2) {
                        tooCloseToWall = true;
                        break;
                    }
                }
                
                if (tooCloseToWall) {
                    continue; // Pr√≥b√°ljuk √∫jra
                }
                
            } while (isPositionOccupied(newFood.x, newFood.y) && attempts < maxAttempts);
            
            if (attempts < maxAttempts) {
                food = newFood;
            } else {
                // Ha nem tal√°ltunk j√≥ helyet, csak egy egyszer≈± v√©letlen hely
                food = {
                    x: Math.floor(Math.random() * (canvas.width / box)) * box,
                    y: Math.floor(Math.random() * (canvas.height / box)) * box
                };
            }
        }

        function createSpecialFood(type) {
            let specialFood;
            let attempts = 0;
            const maxAttempts = 200;
            
            do {
                specialFood = {
                    x: Math.floor(Math.random() * (canvas.width / box)) * box,
                    y: Math.floor(Math.random() * (canvas.height / box)) * box,
                    type: type,
                    spawnScore: score
                };
                attempts++;
            } while (isPositionOccupied(specialFood.x, specialFood.y) && attempts < maxAttempts);
            
            if (attempts < maxAttempts) {
                if (type === 1) {
                    specialFood1 = specialFood;
                    specialFood1DespawnScore = score + 20;
                } else if (type === 2) {
                    specialFood2 = specialFood;
                    specialFood2DespawnScore = score + 20;
                    specialFood2Spawned = true;
                }
            }
        }

        function createSaladFood() {
            let salad;
            let attempts = 0;
            const maxAttempts = 200;
            
            do {
                salad = {
                    x: Math.floor(Math.random() * (canvas.width / box)) * box,
                    y: Math.floor(Math.random() * (canvas.height / box)) * box,
                    spawnScore: score
                };
                attempts++;
            } while (isPositionOccupied(salad.x, salad.y) && attempts < maxAttempts);
            
            if (attempts < maxAttempts) {
                saladFood = salad;
                saladFoodDespawnScore = score + 20;
                saladFoodSpawned = true;
            }
        }

        function isPositionOccupied(x, y) {
            for (let i = 0; i < snake.length; i++) {
                if (snake[i].x === x && snake[i].y === y) {
                    return true;
                }
            }
            
            if (food && food.x === x && food.y === y) {
                return true;
            }
            
            if (specialFood1 && specialFood1.x === x && specialFood1.y === y) {
                return true;
            }
            if (specialFood2 && specialFood2.x === x && specialFood2.y === y) {
                return true;
            }
            if (saladFood && saladFood.x === x && saladFood.y === y) {
                return true;
            }
            
            for (let i = 0; i < walls.length; i++) {
                if (walls[i].x === x && walls[i].y === y) {
                    return true;
                }
            }
            
            return false;
        }

        function addWall() {
            if (wallSequenceIndex >= wallSequence.length) {
                const lastScore = wallSequence[wallSequence.length - 1];
                const diff = wallSequence[wallSequence.length - 1] - wallSequence[wallSequence.length - 2];
                const nextScore = lastScore + diff + (wallSequenceIndex * 10);
                wallSequence.push(nextScore);
            }
            
            let wall;
            let attempts = 0;
            const maxAttempts = 200;
            
            do {
                wall = {
                    x: Math.floor(Math.random() * (canvas.width / box)) * box,
                    y: Math.floor(Math.random() * (canvas.height / box)) * box
                };
                attempts++;
            } while (isPositionOccupied(wall.x, wall.y) && attempts < maxAttempts);
            
            if (attempts < maxAttempts) {
                walls.push(wall);
                wallCount++;
                
                wallSequenceIndex++;
                if (wallSequenceIndex < wallSequence.length) {
                    nextWallScore = wallSequence[wallSequenceIndex];
                } else {
                    const last = wallSequence[wallSequence.length - 1];
                    const prev = wallSequence[wallSequence.length - 2];
                    nextWallScore = last + (last - prev) + 100;
                    wallSequence.push(nextWallScore);
                }
                
                nextWallElement.textContent = nextWallScore;
            }
        }

        function checkSpecialFoodSpawn() {
            if (score >= specialFood1SpawnScore && !specialFood1 && !gamePaused && !powerupPaused) {
                createSpecialFood(1);
                specialFood1SpawnScore += 200;
            }
            
            if (score >= specialFood2SpawnScore && !specialFood2 && !specialFood2Spawned && !gamePaused && !powerupPaused) {
                createSpecialFood(2);
            }
            
            if (score >= 300 && !saladFood && !saladFoodSpawned && !gamePaused && !powerupPaused) {
                createSaladFood();
            }
            
            if (specialFood1 && specialFood1DespawnScore && score >= specialFood1DespawnScore) {
                specialFood1 = null;
                specialFood1DespawnScore = null;
            }
            
            if (specialFood2 && specialFood2DespawnScore && score >= specialFood2DespawnScore) {
                specialFood2 = null;
                specialFood2DespawnScore = null;
            }
            
            if (saladFood && saladFoodDespawnScore && score >= saladFoodDespawnScore) {
                saladFood = null;
                saladFoodDespawnScore = null;
            }
        }

        // === F√ñLDRENG√âS EFFECT ===
        function triggerEarthquake() {
            if (earthquakeActive || score200Triggered) return;
            
            score200Triggered = true;
            earthquakeActive = true;
            
            earthquakeEffect.style.display = 'block';
            originalCanvasTransform = canvas.style.transform;
            
            earthquakeFlashInterval = setInterval(() => {
                earthquakeEffect.style.opacity = Math.random() > 0.5 ? '0.3' : '0.6';
            }, 100);
            
            let shakeIntensity = 10;
            earthquakeShakeInterval = setInterval(() => {
                const x = (Math.random() - 0.5) * shakeIntensity;
                const y = (Math.random() - 0.5) * shakeIntensity;
                const rotate = (Math.random() - 0.5) * 2;
                
                canvas.style.transform = `translate(${x}px, ${y}px) rotate(${rotate}deg)`;
            }, 50);
            
            earthquakeTimer = setTimeout(() => {
                stopEarthquake();
            }, 10000);
        }

        function triggerSuperEarthquake() {
            if (earthquakeActive || score750Triggered) return;
            
            score750Triggered = true;
            earthquakeActive = true;
            
            earthquakeEffect.style.display = 'block';
            originalCanvasTransform = canvas.style.transform;
            
            earthquakeFlashInterval = setInterval(() => {
                earthquakeEffect.style.opacity = Math.random() > 0.5 ? '0.4' : '0.7';
            }, 80);
            
            let shakeIntensity = 15; // 0.5x nagyobb mint a norm√°l
            earthquakeShakeInterval = setInterval(() => {
                const x = (Math.random() - 0.5) * shakeIntensity;
                const y = (Math.random() - 0.5) * shakeIntensity;
                const rotate = (Math.random() - 0.5) * 3;
                
                canvas.style.transform = `translate(${x}px, ${y}px) rotate(${rotate}deg)`;
            }, 40);
            
            earthquakeTimer = setTimeout(() => {
                stopEarthquake();
            }, 15000); // 15 m√°sodperc
        }

        function stopEarthquake() {
            if (!earthquakeActive) return;
            
            earthquakeActive = false;
            
            clearInterval(earthquakeShakeInterval);
            clearInterval(earthquakeFlashInterval);
            clearTimeout(earthquakeTimer);
            
            earthquakeEffect.style.display = 'none';
            canvas.style.transform = originalCanvasTransform;
        }

        // === FORD√çTOTT IR√ÅNY EFFECT ===
        function triggerReverseDay() {
            if (reverseActive || score500Triggered) return;
            
            score500Triggered = true;
            reverseActive = true;
            originalDirection = direction;
            
            // J√°t√©k sz√ºneteltet√©se √©s √ºzenet
            powerupPaused = true;
            clearInterval(game);
            
            reverseEffect.style.display = 'block';
            powerupMessage.innerHTML = "J√°tsszunk ford√≠tott napot!!!üòà";
            powerupMessage.style.display = 'block';
            
            setTimeout(() => {
                powerupMessage.style.display = 'none';
                reverseEffect.style.display = 'block';
                reverseTimerElement.style.display = 'block';
                reverseCountdown = 10;
                reverseTimerElement.textContent = reverseCountdown;
                
                // Visszasz√°ml√°l√°s ind√≠t√°sa
                reverseCountdownInterval = setInterval(() => {
                    reverseCountdown--;
                    reverseTimerElement.textContent = reverseCountdown;
                    
                    if (reverseCountdown <= 0) {
                        stopReverseDay();
                    }
                }, 1000);
                
                powerupPaused = false;
                if (gameRunning && !gamePaused) {
                    clearInterval(game);
                    game = setInterval(gameLoop, currentGameSpeed);
                }
                
                // 10 m√°sodperc ut√°n le√°ll√≠t√°s
                reverseTimer = setTimeout(() => {
                    stopReverseDay();
                }, 10000);
                
            }, 4000);
        }

        function stopReverseDay() {
            if (!reverseActive) return;
            
            reverseActive = false;
            
            clearInterval(reverseCountdownInterval);
            clearTimeout(reverseTimer);
            
            reverseEffect.style.display = 'none';
            reverseTimerElement.style.display = 'none';
            
            // Ir√°ny vissza√°ll√≠t√°sa
            direction = originalDirection;
        }

        function getReversedDirection(inputDirection) {
            switch(inputDirection) {
                case 'up': return 'down';
                case 'down': return 'up';
                case 'left': return 'right';
                case 'right': return 'left';
                default: return inputDirection;
            }
        }

        function activatePowerup() {
            powerupPaused = true;
            clearInterval(game);
            
            powerupEffect.style.display = 'block';
            powerupMessage.innerHTML = "A k√©k tabit√≥l nagy lesz a k√≠gy√≥, de gyors is ‚ö°";
            powerupMessage.style.display = 'block';
            
            if (powerupTimer) clearTimeout(powerupTimer);
            powerupTimer = setTimeout(() => {
                powerupEffect.style.display = 'none';
                powerupMessage.style.display = 'none';
                
                powerupPaused = false;
                powerupActive = true;
                
                for (let i = 0; i < 5; i++) {
                    snake.push({...snake[snake.length - 1]});
                }
                
                score += 50;
                scoreElement.textContent = score;
                
                currentGameSpeed = Math.floor(baseGameSpeed / 2);
                
                speedIndicator.textContent = "2X SEBESS√âG!";
                speedIndicator.style.display = 'block';
                
                if (gameRunning && !gamePaused) {
                    clearInterval(game);
                    game = setInterval(gameLoop, currentGameSpeed);
                }
                
                // 20 m√°sodperc ut√°n vissza√°ll√≠t√°s
                if (powerupEndTimer) clearTimeout(powerupEndTimer);
                powerupEndTimer = setTimeout(() => {
                    resetGameSpeed();
                }, 20000);
                
            }, 4000);
        }

        function activateSalad() {
            powerupPaused = true;
            clearInterval(game);
            
            saladEffect.style.display = 'block';
            powerupMessage.innerHTML = "A sal√°ta seg√≠t a fogy√°sban. (Igen a pontod is fogyott.üòà)";
            powerupMessage.style.display = 'block';
            
            if (powerupTimer) clearTimeout(powerupTimer);
            powerupTimer = setTimeout(() => {
                saladEffect.style.display = 'none';
                powerupMessage.style.display = 'none';
                
                powerupPaused = false;
                
                // 5 egys√©g elt√°vol√≠t√°sa a k√≠gy√≥b√≥l
                for (let i = 0; i < 5; i++) {
                    if (snake.length > 2) {
                        snake.pop();
                    }
                }
                
                // 50 pont levon√°sa (de ne legyen negat√≠v)
                score = Math.max(0, score - 50);
                scoreElement.textContent = score;
                
                if (gameRunning && !gamePaused) {
                    clearInterval(game);
                    game = setInterval(gameLoop, currentGameSpeed);
                }
                
            }, 4000);
        }

        function resetGameSpeed() {
            currentGameSpeed = baseGameSpeed;
            powerupActive = false;
            speedIndicator.style.display = 'none';
            
            if (gameRunning && !gamePaused && !powerupPaused) {
                clearInterval(game);
                game = setInterval(gameLoop, currentGameSpeed);
            }
        }

        function changeDirection(newDirection) {
            if (gamePaused || !gameRunning || powerupPaused || gameWon) return;
            
            let actualDirection = newDirection;
            
            // Ha ford√≠tott nap van, megford√≠tjuk az ir√°nyt
            if (reverseActive) {
                actualDirection = getReversedDirection(newDirection);
            }
            
            if (
                (actualDirection === 'left' && direction !== 'right') ||
                (actualDirection === 'right' && direction !== 'left') ||
                (actualDirection === 'up' && direction !== 'down') ||
                (actualDirection === 'down' && direction !== 'up')
            ) {
                direction = actualDirection;
            }
        }

        // === CSUSZTAT√ÅSOS (SWIPE) IR√ÅNY√çT√ÅS ===
        canvas.addEventListener('touchstart', function(event) {
            if (!gameRunning || gamePaused || powerupPaused || gameWon) return;
            touchStartX = event.touches[0].clientX;
            touchStartY = event.touches[0].clientY;
            event.preventDefault();
        }, { passive: false });

        canvas.addEventListener('touchend', function(event) {
            if (!gameRunning || gamePaused || powerupPaused || gameWon) return;
            
            const touchEndX = event.changedTouches[0].clientX;
            const touchEndY = event.changedTouches[0].clientY;
            
            const dx = touchEndX - touchStartX;
            const dy = touchEndY - touchStartY;
            
            if (Math.abs(dx) > 20 || Math.abs(dy) > 20) {
                if (Math.abs(dx) > Math.abs(dy)) {
                    if (dx > 0) changeDirection('right');
                    else changeDirection('left');
                } else {
                    if (dy > 0) changeDirection('down');
                    else changeDirection('up');
                }
            }
            
            event.preventDefault();
        }, { passive: false });

        function collisionDetection(head) {
            if (head.x < 0 || head.y < 0 || head.x >= canvas.width || head.y >= canvas.height) {
                return true;
            }
            
            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) {
                    return true;
                }
            }
            
            for (let i = 0; i < walls.length; i++) {
                if (head.x === walls[i].x && head.y === walls[i].y) {
                    return true;
                }
            }
            
            return false;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // H√°tt√©r rajzol√°sa
            if (earthquakeActive) {
                ctx.fillStyle = '#8B0000';
            } else {
                ctx.fillStyle = 'rgba(15, 52, 96, 0.65)';
            }
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Grid vonalak
            if (earthquakeActive) {
                ctx.strokeStyle = 'rgba(255, 100, 100, 0.3)';
            } else {
                ctx.strokeStyle = 'rgba(255, 0, 0, 0.1)';
            }
            
            for (let i = 0; i < canvas.width; i += box) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            for (let j = 0; j < canvas.height; j += box) {
                ctx.beginPath();
                ctx.moveTo(0, j);
                ctx.lineTo(canvas.width, j);
                ctx.stroke();
            }
            
            // Falak rajzol√°sa
            for (let i = 0; i < walls.length; i++) {
                let offsetX = 0;
                let offsetY = 0;
                if (earthquakeActive) {
                    offsetX = (Math.random() - 0.5) * 3;
                    offsetY = (Math.random() - 0.5) * 3;
                }
                
                ctx.fillStyle = earthquakeActive ? '#FF4500' : '#FF0000';
                ctx.fillRect(walls[i].x + offsetX, walls[i].y + offsetY, box, box);
                
                ctx.strokeStyle = earthquakeActive ? '#CC2200' : '#CC0000';
                ctx.lineWidth = 2;
                ctx.strokeRect(walls[i].x + offsetX, walls[i].y + offsetY, box, box);
                
                ctx.font = `bold ${box}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'white';
                ctx.fillText('üü•', walls[i].x + box/2 + offsetX, walls[i].y + box/2 + offsetY);
            }
            
            // Speci√°lis √©telek rajzol√°sa
            if (specialFood1) {
                let offsetX = 0;
                let offsetY = 0;
                if (earthquakeActive) {
                    offsetX = (Math.random() - 0.5) * 2;
                    offsetY = (Math.random() - 0.5) * 2;
                }
                
                if (imagesLoaded.specialFood1) {
                    ctx.drawImage(specialFood1Image, specialFood1.x + offsetX, specialFood1.y + offsetY, box, box);
                } else {
                    ctx.fillStyle = '#FF4444';
                    ctx.fillRect(specialFood1.x + offsetX, specialFood1.y + offsetY, box, box);
                    
                    ctx.fillStyle = 'white';
                    ctx.font = `bold ${box-4}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('‚ö†Ô∏è', specialFood1.x + box/2 + offsetX, specialFood1.y + box/2 + offsetY);
                }
            }
            
            if (specialFood2) {
                let offsetX = 0;
                let offsetY = 0;
                if (earthquakeActive) {
                    offsetX = (Math.random() - 0.5) * 2;
                    offsetY = (Math.random() - 0.5) * 2;
                }
                
                if (imagesLoaded.specialFood2) {
                    ctx.drawImage(specialFood2Image, specialFood2.x + offsetX, specialFood2.y + offsetY, box, box);
                } else {
                    ctx.fillStyle = '#4169E1';
                    ctx.fillRect(specialFood2.x + offsetX, specialFood2.y + offsetY, box, box);
                    
                    ctx.fillStyle = 'white';
                    ctx.font = `bold ${box-4}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('‚ö°', specialFood2.x + box/2 + offsetX, specialFood2.y + box/2 + offsetY);
                }
            }
            
            if (saladFood) {
                let offsetX = 0;
                let offsetY = 0;
                if (earthquakeActive) {
                    offsetX = (Math.random() - 0.5) * 2;
                    offsetY = (Math.random() - 0.5) * 2;
                }
                
                if (imagesLoaded.saladFood) {
                    ctx.drawImage(saladFoodImage, saladFood.x + offsetX, saladFood.y + offsetY, box, box);
                } else {
                    ctx.fillStyle = '#32CD32';
                    ctx.fillRect(saladFood.x + offsetX, saladFood.y + offsetY, box, box);
                    
                    ctx.fillStyle = 'white';
                    ctx.font = `bold ${box-4}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('ü•ó', saladFood.x + box/2 + offsetX, saladFood.y + box/2 + offsetY);
                }
            }
            
            // K√≠gy√≥ rajzol√°sa
            for (let i = 0; i < snake.length; i++) {
                let offsetX = 0;
                let offsetY = 0;
                if (earthquakeActive) {
                    offsetX = (Math.random() - 0.5) * (i === 0 ? 4 : 2);
                    offsetY = (Math.random() - 0.5) * (i === 0 ? 4 : 2);
                }
                
                if (i === 0) {
                    if (imagesLoaded.snakeHead) {
                        ctx.drawImage(snakeHeadImage, snake[i].x + 1 + offsetX, snake[i].y + 1 + offsetY, box - 2, box - 2);
                    } else {
                        ctx.fillStyle = earthquakeActive ? '#FFA500' : '#FFD700';
                        ctx.fillRect(snake[i].x + 1 + offsetX, snake[i].y + 1 + offsetY, box - 2, box - 2);
                        
                        ctx.fillStyle = '#1a1a2e';
                        ctx.fillRect(snake[i].x + 5 + offsetX, snake[i].y + 5 + offsetY, 4, 4);
                        ctx.fillRect(snake[i].x + box - 9 + offsetX, snake[i].y + 5 + offsetY, 4, 4);
                    }
                } else {
                    if (imagesLoaded.snakeBody) {
                        ctx.drawImage(snakeBodyImage, snake[i].x + 1 + offsetX, snake[i].y + 1 + offsetY, box - 2, box - 2);
                    } else {
                        const darken = Math.min(i * 8, 120);
                        const r = (earthquakeActive ? 255 : 255) - darken;
                        const g = (earthquakeActive ? 165 : 215) - darken * 0.5;
                        ctx.fillStyle = `rgb(${r}, ${g}, 0)`;
                        ctx.fillRect(snake[i].x + 1 + offsetX, snake[i].y + 1 + offsetY, box - 2, box - 2);
                    }
                }
            }
            
            // Norm√°l √©tel rajzol√°sa
            if (imagesLoaded.food) {
                let offsetX = 0;
                let offsetY = 0;
                if (earthquakeActive) {
                    offsetX = (Math.random() - 0.5) * 3;
                    offsetY = (Math.random() - 0.5) * 3;
                }
                ctx.drawImage(foodImage, food.x + offsetX, food.y + offsetY, box, box);
            } else {
                let offsetX = 0;
                let offsetY = 0;
                if (earthquakeActive) {
                    offsetX = (Math.random() - 0.5) * 3;
                    offsetY = (Math.random() - 0.5) * 3;
                }
                
                ctx.fillStyle = earthquakeActive ? '#FFA500' : '#FFD700';
                ctx.fillRect(food.x + offsetX, food.y + offsetY, box, box);
                
                ctx.fillStyle = '#1a1a2e';
                ctx.font = `bold ${box-4}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('C', food.x + box/2 + offsetX, food.y + box/2 + offsetY);
            }
        }

        function gameLoop() {
            if (gamePaused || !gameRunning || powerupPaused || gameWon) return;
            
            // Esem√©nyek ellen≈ërz√©se
            if (score >= 200 && !score200Triggered && !earthquakeActive) {
                triggerEarthquake();
            }
            
            if (score >= 500 && !score500Triggered && !reverseActive) {
                triggerReverseDay();
            }
            
            if (score >= 750 && !score750Triggered && !earthquakeActive) {
                triggerSuperEarthquake();
            }
            
            // Gy≈ëzelem ellen≈ërz√©se
            if (score >= 1000 && !gameWon) {
                winGame();
                return;
            }
            
            let head = {x: snake[0].x, y: snake[0].y};
            
            switch(direction) {
                case 'left': head.x -= box; break;
                case 'up': head.y -= box; break;
                case 'right': head.x += box; break;
                case 'down': head.y += box; break;
            }
            
            snake.unshift(head);
            
            let ateFood = false;
            if (head.x === food.x && head.y === food.y) {
                score += 10;
                scoreElement.textContent = score;
                ateFood = true;
                
                if (score >= nextWallScore) {
                    addWall();
                }
                
                createFood();
            }
            
            let ateSpecial1 = false;
            if (specialFood1 && head.x === specialFood1.x && head.y === specialFood1.y) {
                ateSpecial1 = true;
                specialFood1 = null;
                specialDeathMessage.textContent = "Ne zab√°lj beles üê∑";
                specialDeathMessage.style.display = 'block';
                gameOver();
                return;
            }
            
            let ateSpecial2 = false;
            if (specialFood2 && head.x === specialFood2.x && head.y === specialFood2.y) {
                ateSpecial2 = true;
                specialFood2 = null;
                activatePowerup();
            }
            
            let ateSalad = false;
            if (saladFood && head.x === saladFood.x && head.y === saladFood.y) {
                ateSalad = true;
                saladFood = null;
                activateSalad();
            }
            
            if (!ateFood && !ateSpecial1 && !ateSpecial2 && !ateSalad) {
                snake.pop();
            }
            
            checkSpecialFoodSpawn();
            
            if (collisionDetection(head)) {
                gameOver();
                return;
            }
            
            draw();
        }

        function winGame() {
            gameRunning = false;
            gameWon = true;
            clearInterval(game);
            resetGameSpeed();
            stopEarthquake();
            stopReverseDay();
            
            // Win sz√°ml√°l√≥ n√∂vel√©se
            winCount++;
            localStorage.setItem('chatbacsiWinCount', winCount);
            winCountElement.textContent = winCount;
            
            // Gy≈ëzelmi k√©perny≈ë megjelen√≠t√©se
            winScreen.style.display = 'block';
            
            // Canvas elrejt√©se
            canvas.style.display = 'none';
            
            // Tov√°bbi elemek elrejt√©se
            speedIndicator.style.display = 'none';
            nextWallElement.parentElement.style.display = 'none';
        }

        function gameOver() {
            gameRunning = false;
            clearInterval(game);
            resetGameSpeed();
            stopEarthquake();
            stopReverseDay();
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('chatbacsiHighScore', highScore);
                highScoreElement.textContent = highScore;
                finalScoreElement.innerHTML = `<span style="color:#FFD700">${score}</span> <small>(√öj rekord!)</small>`;
            } else {
                finalScoreElement.textContent = score;
            }
            
            gameOverScreen.style.display = 'block';
        }

        function startGame() {
            if (gameRunning) return;
            
            gameOverScreen.style.display = 'none';
            winScreen.style.display = 'none';
            powerupEffect.style.display = 'none';
            powerupMessage.style.display = 'none';
            specialDeathMessage.style.display = 'none';
            speedIndicator.style.display = 'none';
            earthquakeEffect.style.display = 'none';
            saladEffect.style.display = 'none';
            reverseEffect.style.display = 'none';
            reverseTimerElement.style.display = 'none';
            
            // Canvas vissza√°ll√≠t√°sa
            canvas.style.display = 'block';
            nextWallElement.parentElement.style.display = 'block';
            
            initSnake();
            createFood();
            specialFood1 = null;
            specialFood2 = null;
            saladFood = null;
            specialFood2Spawned = false;
            saladFoodSpawned = false;
            walls = [];
            wallCount = 0;
            wallSequenceIndex = 0;
            score = 0;
            nextWallScore = wallSequence[0];
            specialFood1SpawnScore = 40;
            specialFood2SpawnScore = 100;
            specialFood1DespawnScore = null;
            specialFood2DespawnScore = null;
            saladFoodDespawnScore = null;
            direction = 'right';
            originalDirection = 'right';
            gameRunning = true;
            gamePaused = false;
            gameWon = false;
            powerupActive = false;
            powerupPaused = false;
            earthquakeActive = false;
            score200Triggered = false;
            score500Triggered = false;
            score750Triggered = false;
            reverseActive = false;
            reverseCountdown = 10;
            currentGameSpeed = baseGameSpeed;
            scoreElement.textContent = score;
            winCountElement.textContent = winCount;
            nextWallElement.textContent = nextWallScore;
            
            canvas.style.transform = '';
            
            if (powerupTimer) clearTimeout(powerupTimer);
            if (powerupEndTimer) clearTimeout(powerupEndTimer);
            if (earthquakeTimer) clearTimeout(earthquakeTimer);
            if (earthquakeShakeInterval) clearInterval(earthquakeShakeInterval);
            if (earthquakeFlashInterval) clearInterval(earthquakeFlashInterval);
            if (reverseTimer) clearTimeout(reverseTimer);
            if (reverseCountdownInterval) clearInterval(reverseCountdownInterval);
            
            if (game) clearInterval(game);
            game = setInterval(gameLoop, currentGameSpeed);
            
            draw();
        }

        function pauseGame() {
            if (!gameRunning || powerupPaused || gameWon) return;
            
            gamePaused = !gamePaused;
            const pauseBtn = document.querySelector('.action-btn:nth-child(2)');
            pauseBtn.textContent = gamePaused ? 'FOLYTAT√ÅS' : 'SZ√úNET';
            
            if (!gamePaused) {
                clearInterval(game);
                game = setInterval(gameLoop, currentGameSpeed);
            } else {
                clearInterval(game);
            }
        }

        function resetGame() {
            gameRunning = false;
            gamePaused = false;
            gameWon = false;
            powerupActive = false;
            powerupPaused = false;
            earthquakeActive = false;
            score200Triggered = false;
            score500Triggered = false;
            score750Triggered = false;
            reverseActive = false;
            clearInterval(game);
            resetGameSpeed();
            stopEarthquake();
            stopReverseDay();
            
            initSnake();
            createFood();
            specialFood1 = null;
            specialFood2 = null;
            saladFood = null;
            specialFood2Spawned = false;
            saladFoodSpawned = false;
            walls = [];
            wallCount = 0;
            wallSequenceIndex = 0;
            score = 0;
            nextWallScore = wallSequence[0];
            specialFood1SpawnScore = 40;
            specialFood2SpawnScore = 100;
            specialFood1DespawnScore = null;
            specialFood2DespawnScore = null;
            saladFoodDespawnScore = null;
            direction = 'right';
            originalDirection = 'right';
            currentGameSpeed = baseGameSpeed;
            scoreElement.textContent = score;
            winCountElement.textContent = winCount;
            nextWallElement.textContent = nextWallScore;
            powerupEffect.style.display = 'none';
            powerupMessage.style.display = 'none';
            specialDeathMessage.style.display = 'none';
            speedIndicator.style.display = 'none';
            earthquakeEffect.style.display = 'none';
            saladEffect.style.display = 'none';
            reverseEffect.style.display = 'none';
            reverseTimerElement.style.display = 'none';
            winScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            
            canvas.style.display = 'block';
            nextWallElement.parentElement.style.display = 'block';
            canvas.style.transform = '';
            
            if (powerupTimer) clearTimeout(powerupTimer);
            if (powerupEndTimer) clearTimeout(powerupEndTimer);
            if (earthquakeTimer) clearTimeout(earthquakeTimer);
            if (earthquakeShakeInterval) clearInterval(earthquakeShakeInterval);
            if (earthquakeFlashInterval) clearInterval(earthquakeFlashInterval);
            if (reverseTimer) clearTimeout(reverseTimer);
            if (reverseCountdownInterval) clearInterval(reverseCountdownInterval);
            
            draw();
        }

        // === INICIALIZ√ÅL√ÅS ===
        initSnake();
        createFood();
        
        setTimeout(() => {
            draw();
        }, 100);
    </script>
</body>
</html>